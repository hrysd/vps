user {{user}} {{group}};
worker_processes 2;
worker_rlimit_nofile 1024;

error_log {{log_dir}}/error.log info;

events {
  worker_connections 128;
  use epoll;
}

http {
  include {{install_dir}}/conf/mime.types;
  default_type application/octet-stream;

  log_format ltsv 'time:$time_iso8601\t'
    'ip:$remote_addr\t'
    'method:$request_method\t'
    'vhost:$host\t'
    'path:$request_uri\t'
    'status:$status\t'
    'reqtime:$request_time\t'
    'referer:$http_referer\t'
    'ua:$http_user_agent\t'
  ;

  access_log {{log_dir}}/access.log ltsv;

  connection_pool_size 256;
  client_header_buffer_size 1k;
  large_client_header_buffers 4 2k;
  request_pool_size 4k;

  output_buffers 1 32k;
  postpone_output 1460;

  # Don't follow symlink if the symlink's owner is not the target owner.
  # Enabled for the security reason.
  disable_symlinks if_not_owner;

  server_tokens off;
  ignore_invalid_headers on;

  client_header_timeout 5;
  client_body_timeout 15;
  send_timeout 10;
  keepalive_timeout 20 15;

  gzip on;
  gzip_vary on;
  gzip_comp_level 9;
  gzip_min_length 1100;
  gzip_buffers 16 8k;
  gzip_types text/plain text/css image/bmp;

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  ssl_dhparam {{dhparam_path}};

  ssl_session_timeout 1d;
  ssl_session_cache shared:SSL:50m;
  ssl_session_tickets off;

  ssl_prefer_server_ciphers on;
  ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:
              ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:
              DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:
              ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:
              ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:
              DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:
              AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';

  # 6 months
  add_header Strict-Transport-Security max-age=15768000;

  include {{install_dir}}/conf/sites-enabled/*;
}
